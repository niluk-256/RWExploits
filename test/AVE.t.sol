// SPDX-License-Identifier: MIT
pragma solidity ^0.8.13;

import "forge-std/Test.sol";

// Simple test to get a Flashloan from AaVEE
interface WETH {
    function balanceOf(address addr) external view returns (uint256);

    function approve(address guy, uint wad) external returns (bool);

    function transfer(address dst, uint wad) external returns (bool);

    function deposit() external payable;
}

interface AAVE {
    function flashLoan(
        address receiverAddress,
        address[] calldata assets,
        uint256[] calldata amounts,
        uint256[] calldata modes,
        address onBehalfOf,
        bytes calldata params,
        uint16 referralCode
    ) external;
}

contract FlashLoan {
    WETH weth = WETH(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);
    AAVE aave = AAVE(0x7d2768dE32b0b80b7a3454c06BdAc94A69DDc7A9);
    address[] tokens;
    uint256[] amounts;
    uint256[] nums2;

    function get() external {
        tokens.push(address(weth));
        amounts.push(600 ether); // Approximately  > 1 million $
        nums2.push(0);
        weth.balanceOf(address(this));
        aave.flashLoan(
            address(this),
            tokens,
            amounts,
            nums2,
            address(this),
            "0x",
            0
        );
    }

    function executeOperation(
        address[] calldata assets,
        uint256[] calldata amounts,
        uint256[] calldata premiums,
        address initiator,
        bytes calldata params
    ) external returns (bool) {
        weth.approve(address(aave), type(uint256).max);
        // REPLAY Fee > 0.5 ether  ge   >  910.71 $
        return true;
    }

    receive() external payable {}
}

contract AVE is Test {
    address user;
    FlashLoan internal loan;
    WETH weth = WETH(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);

    function setUp() public {
        vm.createSelectFork("mainnet", 16797974);
        user = makeAddr("user");
        loan = new FlashLoan();
        vm.deal(user, 10 ether);
        vm.startPrank(user);
        weth.deposit{value: 2 ether}();
        weth.transfer(address(loan), 1 ether);
        vm.stopPrank();
        vm.label(address(loan), "LoanContract");
        vm.label(address(weth), "WETHContract");
    }

    //------------
    function testLoan() public {
        vm.startPrank(user);

        loan.get();
        vm.stopPrank();
    }

    //FLASHLOAN CALLS
}
